<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>欧本流量查询</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            background: url('https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758092476926_qdqqd_m8blq9.jpeg') no-repeat center center fixed;
            background-size: cover;
            color: white;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: -1;
        }
        
        .cards-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            max-width: 1200px;
            width: 100%;
            z-index: 1;
        }
        
        .card {
            background: rgba(30, 30, 30, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            width: 100%;
            max-width: 380px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-icon {
            font-size: 20px;
            color: #ffa500;
            width: 24px;
            text-align: center;
        }
        
        .card-name {
            font-size: 16px;
            font-weight: bold;
            color: #ffa500;
            word-break: break-all;
        }
        
        .card-note {
            font-size: 14px;
            color: #bbb;
            background: rgba(255, 165, 0, 0.15);
            padding: 4px 10px;
            border-radius: 12px;
            max-width: 120px;
            text-align: center;
        }
        
        .status {
            font-size: 14px;
            padding: 4px 10px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
            margin-top: 4px;
        }
        
        .status.normal {
            color: #52c41a;
            background: rgba(82, 196, 26, 0.15);
        }
        
        .status.abnormal {
            color: #f5222d;
            background: rgba(245, 34, 45, 0.15);
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 12px 0;
            padding: 0 8px;
        }
        
        .info-label {
            font-size: 15px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .info-value {
            font-size: 17px;
            font-weight: bold;
        }
        
        .progress-container {
            background: rgba(68, 68, 68, 0.6);
            height: 24px;
            border-radius: 8px;
            margin: 18px 0;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 8px;
            position: absolute;
            top: 0;
            left: 0;
            transition: width 0.8s ease;
        }
        
        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            line-height: 24px;
            z-index: 2;
        }
        
        .expire-date {
            text-align: center;
            font-size: 15px;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 15px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        .loading {
            text-align: center;
            margin: 20px 0;
            color: #1890ff;
            font-size: 16px;
        }
        
        .error {
            color: #f5222d;
            text-align: center;
            margin: 15px 0;
            font-size: 15px;
            background: rgba(245, 34, 45, 0.15);
            padding: 10px;
            border-radius: 8px;
        }
        
        .last-update {
            text-align: center;
            margin-top: 25px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            z-index: 1;
        }
        
        .buttons-container {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            font-size: 15px;
            text-decoration: none;
        }
        
        .refresh-btn {
            background: rgba(255, 165, 0, 0.2);
            color: #ffa500;
            border: 1px solid rgba(255, 165, 0, 0.5);
        }
        
        .refresh-btn:hover {
            background: rgba(255, 165, 0, 0.3);
        }
        
        .website-btn {
            background: rgba(24, 144, 255, 0.2);
            color: #1890ff;
            border: 1px solid rgba(24, 144, 255, 0.5);
        }
        
        .website-btn:hover {
            background: rgba(24, 144, 255, 0.3);
        }
        
        .config-panel {
            background: rgba(30, 30, 30, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }
        
        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .config-title {
            font-size: 18px;
            color: #ffa500;
            font-weight: bold;
        }
        
        .config-toggle {
            background: rgba(255, 165, 0, 0.2);
            color: #ffa500;
            border: 1px solid rgba(255, 165, 0, 0.5);
            padding: 5px 10px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .config-content {
            display: none;
        }
        
        .config-item {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .config-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            min-width: 80px;
        }
        
        .config-input {
            flex: 1;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            min-width: 120px;
        }
        
        .config-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .config-btn {
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            flex: 1;
            border: none;
            font-weight: bold;
        }
        
        .save-btn {
            background: rgba(24, 144, 255, 0.2);
            color: #1890ff;
            border: 1px solid rgba(24, 144, 255, 0.5);
        }
        
        .reset-btn {
            background: rgba(245, 34, 45, 0.2);
            color: #f5222d;
            border: 1px solid rgba(245, 34, 45, 0.5);
        }
        
        .add-card-btn {
            background: rgba(82, 196, 26, 0.2);
            color: #52c41a;
            border: 1px solid rgba(82, 196, 26, 0.5);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        .remove-card-btn {
            background: rgba(245, 34, 45, 0.2);
            color: #f5222d;
            border: 1px solid rgba(245, 34, 45, 0.3);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 22px;
        }
        
        @media (max-width: 768px) {
            .cards-container {
                flex-direction: column;
                align-items: center;
            }
            
            .card {
                max-width: 100%;
            }
            
            .buttons-container {
                flex-direction: column;
                align-items: center;
            }
            
            .action-btn {
                width: 200px;
                justify-content: center;
            }
            
            .card-name {
                font-size: 14px;
            }
            
            .config-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .config-label {
                width: 100%;
            }
            
            .config-input {
                width: 100%;
            }
            
            .config-buttons {
                flex-direction: column;
            }
            
            .remove-card-btn {
                margin-top: 8px;
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    
    <div class="config-panel">
        <div class="config-header">
            <div class="config-title">流量卡配置</div>
            <div class="config-toggle" id="configToggle">显示配置</div>
        </div>
        <div class="config-content" id="configContent">
            <div id="configItemsContainer">
                <!-- 配置项将由JavaScript动态生成 -->
            </div>
            
            <button class="add-card-btn" id="addCardBtn">
                <i class="fas fa-plus"></i> 添加新卡
            </button>
            
            <div class="config-buttons">
                <button class="config-btn save-btn" id="saveConfig">保存配置</button>
                <button class="config-btn reset-btn" id="resetConfig">恢复默认配置</button>
            </div>
        </div>
    </div>
    
    <div class="cards-container" id="cardsContainer">
        <!-- 卡片将由JavaScript动态生成 -->
    </div>
    
    <div class="last-update" id="lastUpdate">
        最后更新 
    </div>
    
    <div class="buttons-container">
        <button class="action-btn refresh-btn" id="refreshBtn">
            <i class="fas fa-sync-alt"></i> 手动刷新
        </button>
        
        <a href="http://rang.xuanrangiot.cn/index.html#/" target="_blank" class="action-btn website-btn">
            <i class="fas fa-external-link-alt"></i> 前往官网
        </a>
    </div>

    <script>
        // 全局配置变量
        let cardsConfig = [];
        // 中文数字映射（支持1-10张卡，可扩展）
        const chineseNumbers = ['一', '二', '三', '四', '五', '六', '七', '八', '九', '十'];
        
        // 默认配置
        const defaultConfig = [
            { number: '8682480067', note: '欧本1' }
        ];
        
        // 初始化配置
        function initConfig() {
            // 尝试从本地存储加载配置
            const savedConfig = localStorage.getItem('cardsConfig');
            if (savedConfig) {
                cardsConfig = JSON.parse(savedConfig);
            } else {
                // 使用默认配置
                cardsConfig = [...defaultConfig];
                localStorage.setItem('cardsConfig', JSON.stringify(cardsConfig));
            }
            
            // 更新配置表单
            renderConfigItems();
        }
        
        // 渲染配置项
        function renderConfigItems() {
            const container = document.getElementById('configItemsContainer');
            container.innerHTML = '';
            
            cardsConfig.forEach((card, index) => {
                const chineseNum = chineseNumbers[index] || (index + 1); // 获取中文序号
                const configItem = document.createElement('div');
                configItem.className = 'config-item';
                configItem.innerHTML = `
                    <div style="flex: 1;">
                        <label class="config-label">卡${chineseNum}号码:</label>
                        <input type="text" class="config-input" data-index="${index}" data-type="number" value="${card.number}" placeholder="请输入卡号">
                    </div>
                    <div style="flex: 1;">
                        <label class="config-label">卡${chineseNum}备注:</label>
                        <input type="text" class="config-input" data-index="${index}" data-type="note" value="${card.note}" placeholder="请输入备注">
                    </div>
                    <button class="remove-card-btn" data-index="${index}">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                container.appendChild(configItem);
            });
            
            // 添加删除按钮事件
            document.querySelectorAll('.remove-card-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    if (cardsConfig.length > 1) {
                        cardsConfig.splice(index, 1);
                        renderConfigItems();
                    } else {
                        alert('至少需要保留一张流量卡');
                    }
                });
            });
        }
        
        // 保存配置
        function saveConfig() {
            // 收集所有配置项
            const numberInputs = document.querySelectorAll('.config-input[data-type="number"]');
            const noteInputs = document.querySelectorAll('.config-input[data-type="note"]');
            
            cardsConfig = [];
            
            numberInputs.forEach((input, index) => {
                const number = input.value.trim();
                const note = noteInputs[index].value.trim();
                
                if (number) {
                    cardsConfig.push({ 
                        number, 
                        note: note || `卡${chineseNumbers[index] || (index + 1)}` 
                    });
                }
            });
            
            // 保存到本地存储
            localStorage.setItem('cardsConfig', JSON.stringify(cardsConfig));
            
            // 重新生成卡片
            generateCards();
            
            // 刷新数据
            refreshAllCards();
            
            // 折叠配置面板
            document.getElementById('configContent').style.display = 'none';
            document.getElementById('configToggle').textContent = '显示配置';
            
            alert('配置已保存');
        }
        
        // 恢复默认配置
        function resetConfig() {
            if (confirm('确定要恢复默认配置吗 当前配置将会被覆盖')) {
                cardsConfig = [...defaultConfig];
                localStorage.setItem('cardsConfig', JSON.stringify(cardsConfig));
                renderConfigItems();
                generateCards();
                refreshAllCards();
                
                // 折叠配置面板
                document.getElementById('configContent').style.display = 'none';
                document.getElementById('configToggle').textContent = '显示配置';
                
                alert('已恢复默认配置');
            }
        }
        
        // 添加新卡
        function addNewCard() {
            cardsConfig.push({ number: '', note: '' });
            renderConfigItems();
        }
        
        // 生成卡片
        function generateCards() {
            const cardsContainer = document.getElementById('cardsContainer');
            cardsContainer.innerHTML = '';
            
            cardsConfig.forEach((card, index) => {
                const cardId = index + 1;
                const chineseNum = chineseNumbers[index] || (index + 1); // 中文序号
                const cardElement = document.createElement('div');
                cardElement.className = 'card';
                cardElement.id = `card${cardId}`;
                
                cardElement.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-sim-card card-icon"></i>
                            <span class="card-name">卡${chineseNum}</span> <!-- 显示中文序号 -->
                        </div>
                        <div class="card-note">${card.note}</div>
                    </div>
                    
                    <div class="loading" id="loading${cardId}">
                        <i class="fas fa-spinner fa-spin"></i> 正在查询 请稍候
                    </div>
                    
                    <div id="result${cardId}" style="display: none;">
                        <div class="info-row">
                            <span class="info-label">总流量</span>
                            <span class="info-value" id="totalData${cardId}">0 00G</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">剩余流量</span>
                            <span class="info-value" id="remainingData${cardId}">0 00G</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">已用流量</span>
                            <span class="info-value" id="usedData${cardId}">0 00G</span>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-bar" id="progressBar${cardId}"></div>
                            <div class="progress-text" id="progressText${cardId}">0%</div>
                        </div>
                        
                        <div class="expire-date" id="expireDate${cardId}">到期时间 --</div>
                    </div>
                    
                    <div id="error${cardId}" class="error" style="display: none;"></div>
                `;
                
                cardsContainer.appendChild(cardElement);
            });
        }
        
        // 根据百分比获取剩余流量颜色
        function getRemainingColor(percent) {
            percent = parseFloat(percent);
            if (percent < 0) return '#cf1322';
            if (percent <= 10) return '#ff4d4f';
            if (percent <= 15) return '#ff7a45';
            if (percent <= 20) return '#ffa940';
            if (percent <= 25) return '#ffc53d';
            if (percent <= 30) return '#fadb14';
            if (percent <= 35) return '#bae637';
            if (percent <= 40) return '#95de64';
            if (percent <= 45) return '#73d13d';
            if (percent <= 50) return '#52c41a';
            if (percent <= 55) return '#389e0d';
            if (percent <= 60) return '#237804';
            if (percent <= 65) return '#135200';
            if (percent <= 70) return '#092b00';
            if (percent <= 75) return '#006d75';
            if (percent <= 80) return '#08979c';
            if (percent <= 85) return '#13c2c2';
            if (percent <= 90) return '#36cfc9';
            if (percent <= 95) return '#5cdbd3';
            return '#87e8de';
        }
        
        // 根据百分比获取进度条颜色
        function getProgressColor(percent) {
            if (percent < 50) return '#52c41a';
            if (percent < 80) return '#faad14';
            return '#f5222d';
        }
        
        // 格式化日期时间
        function formatDateTime(date) {
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            
            return `${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
        
        // JSONP回调函数
        function handleJsonpResponse(data, cardId) {
            document.getElementById(`loading${cardId}`).style.display = 'none';
            
            if (data.code === 1 && data.data) {
                displayData(data.data, cardId);
            } else {
                showError(`获取数据失败 请检查卡号是否正确`, cardId);
            }
            
            // 更新最后更新时间
            const now = new Date();
            document.getElementById('lastUpdate').textContent = `最后更新 ${formatDateTime(now)}`;
        }
        
        // 获取流量数据
        function fetchTrafficData(cardId, cardNumber) {
            // 显示加载中
            document.getElementById(`loading${cardId}`).style.display = 'block';
            document.getElementById(`error${cardId}`).style.display = 'none';
            document.getElementById(`result${cardId}`).style.display = 'none';
            
            try {
                // 创建JSONP脚本
                const callbackName = `jsonp_callback_${cardId}_${new Date().getTime()}`;
                window[callbackName] = function(data) {
                    handleJsonpResponse(data, cardId);
                };
                
                const script = document.createElement('script');
                script.src = `http://rang.xuanrangiot.cn/api/card/intelligentDetection?dev_no=${cardNumber}&callback=${callbackName}`;
                
                // 设置超时处理
                const timeoutId = setTimeout(() => {
                    document.getElementById(`loading${cardId}`).style.display = 'none';
                    showError('请求超时 请重试', cardId);
                    if (document.body.contains(script)) {
                        document.body.removeChild(script);
                    }
                    delete window[callbackName];
                }, 10000);
                
                // 请求完成后的清理
                script.onload = script.onerror = function() {
                    clearTimeout(timeoutId);
                    if (document.body.contains(script)) {
                        document.body.removeChild(script);
                    }
                    setTimeout(() => {
                        delete window[callbackName];
                    }, 100);
                };
                
                document.body.appendChild(script);
            } catch (e) {
                console.error("请求失败", e);
                document.getElementById(`loading${cardId}`).style.display = 'none';
                showError(`请求失败 ${e.message}`, cardId);
            }
        }
        
        // 显示数据
        function displayData(data, cardId) {
            document.getElementById(`error${cardId}`).style.display = 'none';
            document.getElementById(`loading${cardId}`).style.display = 'none';
            
            const used = ((data.totalAmount - data.surplus) / 1024) || 0;
            const total = (data.totalAmount / 1024) || 0;
            const remain = total - used;
            const expire = data.expiretime?.split(" ")[0] || "--";
            const description = data.description || "";
            const usedPercent = total > 0 ? (used / total * 100) : 0;
            
            // 更新状态
            const statusElement = document.createElement('span');
            statusElement.textContent = description === "该卡状态正常" ? "状态正常" : "状态异常";
            statusElement.className = description === "该卡状态正常" ? "status normal" : "status abnormal";
            
            // 添加到卡片头部
            const cardHeader = document.querySelector(`#card${cardId} .card-header`);
            if (!cardHeader.querySelector('.status')) {
                cardHeader.appendChild(statusElement);
            } else {
                cardHeader.replaceChild(statusElement, cardHeader.querySelector('.status'));
            }
            
            // 更新流量数据
            document.getElementById(`totalData${cardId}`).textContent = `${total.toFixed(2)}G`;
            document.getElementById(`remainingData${cardId}`).textContent = `${remain.toFixed(2)}G`;
            document.getElementById(`remainingData${cardId}`).style.color = getRemainingColor((remain / total * 100).toFixed(1));
            document.getElementById(`usedData${cardId}`).textContent = `${used.toFixed(2)}G`;
            
            // 更新进度条
            const progressBar = document.getElementById(`progressBar${cardId}`);
            const progressText = document.getElementById(`progressText${cardId}`);
            const progressWidth = Math.min(usedPercent, 100);
            
            progressBar.style.width = `${progressWidth}%`;
            progressBar.style.backgroundColor = getProgressColor(usedPercent);
            progressText.textContent = `${usedPercent.toFixed(1)}%`;
            
            // 更新到期时间
            document.getElementById(`expireDate${cardId}`).textContent = `到期时间 ${expire}`;
            
            // 显示结果区域
            document.getElementById(`result${cardId}`).style.display = 'block';
        }
        
        // 显示错误信息
        function showError(message, cardId) {
            const errorElement = document.getElementById(`error${cardId}`);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            document.getElementById(`result${cardId}`).style.display = 'none';
            document.getElementById(`loading${cardId}`).style.display = 'none';
        }
        
        // 刷新所有卡片数据
        function refreshAllCards() {
            cardsConfig.forEach((card, index) => {
                const cardId = index + 1;
                fetchTrafficData(cardId, card.number);
            });
        }
        
        // 页面加载完成后初始化
        window.addEventListener('load', function() {
            // 初始化配置
            initConfig();
            
            // 生成卡片
            generateCards();
            
            // 刷新数据
            refreshAllCards();
            
            // 添加手动刷新按钮事件
            document.getElementById('refreshBtn').addEventListener('click', refreshAllCards);
            
            // 配置面板切换
            document.getElementById('configToggle').addEventListener('click', function() {
                const content = document.getElementById('configContent');
                if (content.style.display === 'block') {
                    content.style.display = 'none';
                    this.textContent = '显示配置';
                } else {
                    content.style.display = 'block';
                    this.textContent = '隐藏配置';
                }
            });
            
            // 保存配置按钮
            document.getElementById('saveConfig').addEventListener('click', saveConfig);
            
            // 恢复默认配置按钮
            document.getElementById('resetConfig').addEventListener('click', resetConfig);
            
            // 添加新卡按钮
            document.getElementById('addCardBtn').addEventListener('click', addNewCard);
        });
    </script>
</body>
</html>